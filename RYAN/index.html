import React, { useState } from 'react';
import { Calculator, BookOpen, TrendingUp, DollarSign, Activity, Info } from 'lucide-react';

const StockValuationCalculator = () => {
  const [activeTab, setActiveTab] = useState('PE');

  // State for P/E Valuation
  const [peEPS, setPeEPS] = useState('');
  const [peRatio, setPeRatio] = useState('');
  
  // State for P/B Valuation
  const [pbNAV, setPbNAV] = useState(''); // Net Asset Value (Book Value)
  const [pbRatio, setPbRatio] = useState('');

  // State for P/S Valuation
  const [psSales, setPsSales] = useState('');
  const [psRatio, setPsRatio] = useState('');

  // State for Graham Number
  const [grahamEPS, setGrahamEPS] = useState('');
  const [grahamNAV, setGrahamNAV] = useState('');

  // State for DDM (Gordon)
  const [ddmDividend, setDdmDividend] = useState('');
  const [ddmRate, setDdmRate] = useState(''); // Required Rate of Return
  const [ddmGrowth, setDdmGrowth] = useState('');

  // Helper to format currency
  const formatCurrency = (val) => {
    const num = parseFloat(val);
    if (isNaN(num) || !isFinite(num)) return '---';
    return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' }).format(num);
  };

  // Calculations
  const calculatePE = () => {
    const res = parseFloat(peEPS) * parseFloat(peRatio);
    return formatCurrency(res);
  };

  const calculatePB = () => {
    const res = parseFloat(pbNAV) * parseFloat(pbRatio);
    return formatCurrency(res);
  };

  const calculatePS = () => {
    const res = parseFloat(psSales) * parseFloat(psRatio);
    return formatCurrency(res);
  };

  const calculateGraham = () => {
    // Sqrt(22.5 * EPS * NAV)
    const val = 22.5 * parseFloat(grahamEPS) * parseFloat(grahamNAV);
    if (val < 0) return "無法計算 (數值為負)";
    const res = Math.sqrt(val);
    return formatCurrency(res);
  };

  const calculateDDM = () => {
    const d1 = parseFloat(ddmDividend);
    const r = parseFloat(ddmRate) / 100;
    const g = parseFloat(ddmGrowth) / 100;

    if (r <= g) return "無效 (折現率需 > 成長率)";
    
    const res = d1 / (r - g);
    return formatCurrency(res);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">
      <div className="max-w-4xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="text-center space-y-2 py-6">
          <div className="inline-flex items-center justify-center p-3 bg-blue-600 rounded-full text-white shadow-lg mb-2">
            <Calculator size={32} />
          </div>
          <h1 className="text-3xl font-bold text-slate-900">股票合理估值計算機</h1>
          <p className="text-slate-600">選擇適合的模型，輸入數值，快速算出目標價</p>
        </header>

        {/* Section 1: Comparison Table */}
        <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="bg-slate-100 px-6 py-4 border-b border-slate-200 flex items-center gap-2">
            <BookOpen className="text-blue-600" size={20} />
            <h2 className="text-lg font-semibold">估值方法對照表</h2>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                <tr>
                  <th className="px-6 py-3">估值方法</th>
                  <th className="px-6 py-3">適用公司類型</th>
                  <th className="px-6 py-3">核心公式</th>
                  <th className="px-6 py-3">說明</th>
                </tr>
              </thead>
              <tbody>
                <tr className="bg-white border-b hover:bg-slate-50">
                  <td className="px-6 py-4 font-medium text-blue-600">本益比法 (P/E)</td>
                  <td className="px-6 py-4">獲利穩定的成熟股 (如: 台積電)</td>
                  <td className="px-6 py-4 font-mono text-xs bg-slate-50 rounded">股價 = EPS × 合理倍數</td>
                  <td className="px-6 py-4">最常見，但不適用虧損公司。</td>
                </tr>
                <tr className="bg-white border-b hover:bg-slate-50">
                  <td className="px-6 py-4 font-medium text-blue-600">股價淨值比法 (P/B)</td>
                  <td className="px-6 py-4">景氣循環股、金融股 (如: 中鋼、兆豐金)</td>
                  <td className="px-6 py-4 font-mono text-xs bg-slate-50 rounded">股價 = 每股淨值 × 合理倍數</td>
                  <td className="px-6 py-4">當獲利不穩時，看資產(淨值)較安全。</td>
                </tr>
                <tr className="bg-white border-b hover:bg-slate-50">
                  <td className="px-6 py-4 font-medium text-blue-600">股價營收比法 (P/S)</td>
                  <td className="px-6 py-4">新創、高成長但尚未獲利 (如: SaaS軟體)</td>
                  <td className="px-6 py-4 font-mono text-xs bg-slate-50 rounded">股價 = 每股營收 × 合理倍數</td>
                  <td className="px-6 py-4">看市場佔有率與營收規模。</td>
                </tr>
                <tr className="bg-white border-b hover:bg-slate-50">
                  <td className="px-6 py-4 font-medium text-blue-600">葛拉漢定價法</td>
                  <td className="px-6 py-4">傳產、價值被低估的大型股</td>
                  <td className="px-6 py-4 font-mono text-xs bg-slate-50 rounded">√(22.5 × EPS × 每股淨值)</td>
                  <td className="px-6 py-4">保守型投資人的最愛，同時看獲利與淨值。</td>
                </tr>
                <tr className="bg-white border-b hover:bg-slate-50">
                  <td className="px-6 py-4 font-medium text-blue-600">股利折現模型 (DDM)</td>
                  <td className="px-6 py-4">配息穩定的定存股 (如: 中華電)</td>
                  <td className="px-6 py-4 font-mono text-xs bg-slate-50 rounded">股價 = 股利 ÷ (折現率 - 成長率)</td>
                  <td className="px-6 py-4">假設價值來自於未來領到的股息。</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        {/* Section 2: Calculators */}
        <section className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
          {/* Tabs */}
          <div className="flex overflow-x-auto border-b border-slate-200">
            {[
              { id: 'PE', label: '本益比估價', icon: TrendingUp },
              { id: 'PB', label: '股價淨值比', icon: BookOpen },
              { id: 'PS', label: '股價營收比', icon: Activity },
              { id: 'Graham', label: '葛拉漢公式', icon: DollarSign },
              { id: 'DDM', label: '股利折現', icon: Calculator },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex-1 min-w-[120px] py-4 px-2 text-sm font-medium flex flex-col items-center gap-2 transition-colors duration-200 ${
                  activeTab === tab.id
                    ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                }`}
              >
                <tab.icon size={20} />
                {tab.label}
              </button>
            ))}
          </div>

          <div className="p-6 md:p-8">
            {/* PE Calculator */}
            {activeTab === 'PE' && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-2">
                  <Info className="shrink-0 mt-0.5" size={16} />
                  <p>
                    公式：<strong>合理股價 = 預估 EPS × 合理本益比</strong><br/>
                    建議輸入「未來一年的預估 EPS」以及該股票「過去 3-5 年的平均本益比區間」。
                  </p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">每股盈餘 (EPS)</label>
                      <input type="number" value={peEPS} onChange={(e) => setPeEPS(e.target.value)} placeholder="例如: 10" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">合理本益比倍數 (P/E)</label>
                      <input type="number" value={peRatio} onChange={(e) => setPeRatio(e.target.value)} placeholder="例如: 15" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-xl p-6 flex flex-col justify-center items-center text-center">
                    <span className="text-slate-400 text-sm uppercase tracking-wider mb-2">試算目標價</span>
                    <span className="text-4xl font-bold text-green-400">{calculatePE()}</span>
                  </div>
                </div>
              </div>
            )}

            {/* PB Calculator */}
            {activeTab === 'PB' && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-2">
                  <Info className="shrink-0 mt-0.5" size={16} />
                  <p>
                    公式：<strong>合理股價 = 每股淨值 × 合理股價淨值比</strong><br/>
                    適合用於獲利不穩定但資產價值明確的公司（如鋼鐵、航運、金融）。
                  </p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">每股淨值 (NAV)</label>
                      <input type="number" value={pbNAV} onChange={(e) => setPbNAV(e.target.value)} placeholder="例如: 25.5" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">合理股價淨值比 (P/B)</label>
                      <input type="number" value={pbRatio} onChange={(e) => setPbRatio(e.target.value)} placeholder="例如: 1.2" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-xl p-6 flex flex-col justify-center items-center text-center">
                    <span className="text-slate-400 text-sm uppercase tracking-wider mb-2">試算目標價</span>
                    <span className="text-4xl font-bold text-green-400">{calculatePB()}</span>
                  </div>
                </div>
              </div>
            )}

            {/* PS Calculator */}
            {activeTab === 'PS' && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-2">
                  <Info className="shrink-0 mt-0.5" size={16} />
                  <p>
                    公式：<strong>合理股價 = 每股營收 × 合理股價營收比</strong><br/>
                    適用於尚未獲利但營收成長快速的新創公司。
                  </p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">每股營收 (Sales Per Share)</label>
                      <input type="number" value={psSales} onChange={(e) => setPsSales(e.target.value)} placeholder="總營收 ÷ 總股數" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">合理股價營收比 (P/S)</label>
                      <input type="number" value={psRatio} onChange={(e) => setPsRatio(e.target.value)} placeholder="例如: 4.5" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-xl p-6 flex flex-col justify-center items-center text-center">
                    <span className="text-slate-400 text-sm uppercase tracking-wider mb-2">試算目標價</span>
                    <span className="text-4xl font-bold text-green-400">{calculatePS()}</span>
                  </div>
                </div>
              </div>
            )}

            {/* Graham Calculator */}
            {activeTab === 'Graham' && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-2">
                  <Info className="shrink-0 mt-0.5" size={16} />
                  <p>
                    公式：<strong>合理價 = √(22.5 × EPS × 每股淨值)</strong><br/>
                    這是價值投資之父葛拉漢提出的保守估值法，假設合理本益比 15 倍 × 合理淨值比 1.5 倍 = 22.5。
                  </p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">每股盈餘 (EPS)</label>
                      <input type="number" value={grahamEPS} onChange={(e) => setGrahamEPS(e.target.value)} placeholder="例如: 5" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">每股淨值 (NAV)</label>
                      <input type="number" value={grahamNAV} onChange={(e) => setGrahamNAV(e.target.value)} placeholder="例如: 40" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-xl p-6 flex flex-col justify-center items-center text-center">
                    <span className="text-slate-400 text-sm uppercase tracking-wider mb-2">葛拉漢合理價</span>
                    <span className="text-4xl font-bold text-green-400">{calculateGraham()}</span>
                  </div>
                </div>
              </div>
            )}

            {/* DDM Calculator */}
            {activeTab === 'DDM' && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-2">
                  <Info className="shrink-0 mt-0.5" size={16} />
                  <p>
                    公式 (高登模型)：<strong>股價 = 明年股利 ÷ (折現率 - 成長率)</strong><br/>
                    注意：折現率 (您期望的報酬率) 必須大於 股利成長率，否則公式無效。
                  </p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">預估明年股利 (D1)</label>
                      <input type="number" value={ddmDividend} onChange={(e) => setDdmDividend(e.target.value)} placeholder="例如: 3.5" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">折現率 (期望報酬率 %)</label>
                      <input type="number" value={ddmRate} onChange={(e) => setDdmRate(e.target.value)} placeholder="通常設 5~10，例如: 8" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">股利長期成長率 (%)</label>
                      <input type="number" value={ddmGrowth} onChange={(e) => setDdmGrowth(e.target.value)} placeholder="保守估計，例如: 3" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-xl p-6 flex flex-col justify-center items-center text-center">
                    <span className="text-slate-400 text-sm uppercase tracking-wider mb-2">試算目標價</span>
                    <span className="text-4xl font-bold text-green-400">{calculateDDM()}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </section>

        {/* Footer Info */}
        <footer className="text-center text-slate-500 text-sm pb-8">
          <p>免責聲明：本工具僅供教學與試算使用，不代表任何投資建議。投資一定有風險，投資前請務必自行評估。</p>
        </footer>

      </div>
    </div>
  );
};

export default StockValuationCalculator;
